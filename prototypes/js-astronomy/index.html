<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Astronomy Engine Test</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00bcd4, #4CAF50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin: 4px 0;
            padding: 2px 0;
        }

        .log-entry.info {
            color: #64B5F6;
        }

        .log-entry.success {
            color: #81C784;
        }

        .log-entry.warning {
            color: #FFD54F;
        }

        .log-entry.error {
            color: #E57373;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th,
        .results-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-table th {
            background: rgba(0, 188, 212, 0.2);
            color: #00bcd4;
        }

        .results-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .zone-A {
            background: rgba(0, 200, 0, 0.3);
        }

        .zone-B {
            background: rgba(200, 200, 0, 0.3);
        }

        .zone-C {
            background: rgba(255, 165, 0, 0.3);
        }

        .zone-D {
            background: rgba(200, 0, 0, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #00bcd4, #4CAF50);
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 188, 212, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #00bcd4;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .badge-small {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .badge-fast {
            background: rgba(0, 188, 212, 0.2);
            color: #00bcd4;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üåô JavaScript Astronomy Engine</h1>
        <p class="subtitle">
            Pure JS astronomy calculations
            <span class="badge badge-small">~200KB</span>
            <span class="badge badge-fast">Instant</span>
        </p>

        <div class="status-card">
            <h3>üìä Status</h3>
            <div class="log" id="log"></div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" id="runBtn" disabled>‚ñ∂Ô∏è Loading Library...</button>
        </div>

        <div class="stats" id="stats">
            <div class="stat-box">
                <div class="stat-value" id="downloadSize">~200KB</div>
                <div class="stat-label">Library Size</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="loadTime">-</div>
                <div class="stat-label">Load Time</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="calcTime">-</div>
                <div class="stat-label">Calc Time</div>
            </div>
        </div>

        <div id="resultsContainer" class="hidden">
            <h3 style="margin: 30px 0 15px;">üìä Results (30¬∞E Longitude Line)</h3>
            <table class="results-table" id="resultsTable">
                <thead>
                    <tr>
                        <th>Lat</th>
                        <th>Sunset (UTC)</th>
                        <th>Moon Alt</th>
                        <th>Elongation</th>
                        <th>W' (arcmin)</th>
                        <th>Odeh Zone</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Logging utility
        const logEl = document.getElementById('log');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        const DEG2RAD = Math.PI / 180;
        const RAD2DEG = 180 / Math.PI;

        // Load Astronomy Engine dynamically with fallback URLs
        const loadStart = performance.now();
        log('Loading Astronomy Engine library...', 'info');

        const cdnUrls = [
            'https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.js',
            'https://unpkg.com/astronomy-engine@2.1.19/astronomy.browser.js',
            'https://cdn.jsdelivr.net/npm/astronomy-engine/astronomy.browser.js'
        ];

        async function loadAstronomyLibrary() {
            for (const url of cdnUrls) {
                try {
                    log(`Trying: ${url.split('/').pop()}...`, 'info');

                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const code = await response.text();

                    // Execute the library code
                    const script = document.createElement('script');
                    script.textContent = code;
                    document.head.appendChild(script);

                    // Check if it loaded
                    if (typeof Astronomy !== 'undefined') {
                        const loadTime = ((performance.now() - loadStart)).toFixed(0);
                        document.getElementById('loadTime').textContent = loadTime + 'ms';
                        log(`Astronomy Engine loaded in ${loadTime}ms!`, 'success');
                        log('Ready! Click "Run Calculation" to test.', 'success');

                        document.getElementById('runBtn').disabled = false;
                        document.getElementById('runBtn').textContent = '‚ñ∂Ô∏è Run Calculation';
                        return true;
                    }
                } catch (err) {
                    log(`Failed: ${err.message}`, 'warning');
                }
            }

            log('All CDN sources failed! Trying inline fallback...', 'error');
            return false;
        }

        /**
         * Find sunset time for a given location and date
         */
        function findSunset(lat, lon, year, month, day) {
            const observer = new Astronomy.Observer(lat, lon, 0);

            // Start searching from noon local time
            const startDate = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
            const startTime = Astronomy.MakeTime(startDate);

            // Search for next sunset (-1 = setting, not rising)
            const sunset = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, -1, startTime, 1);
            return sunset;
        }

        /**
         * Get Moon and Sun positions at a specific time
         */
        function getMoonSunData(lat, lon, time) {
            const observer = new Astronomy.Observer(lat, lon, 0);

            // Sun position
            const sunEquator = Astronomy.Equator(Astronomy.Body.Sun, time, observer, true, true);
            const sunHorizon = Astronomy.Horizon(time, observer, sunEquator.ra, sunEquator.dec, 'normal');

            // Moon position
            const moonEquator = Astronomy.Equator(Astronomy.Body.Moon, time, observer, true, true);
            const moonHorizon = Astronomy.Horizon(time, observer, moonEquator.ra, moonEquator.dec, 'normal');

            // Elongation (angular separation between Sun and Moon)
            const elongation = Astronomy.AngleBetween(
                Astronomy.GeoVector(Astronomy.Body.Sun, time, true),
                Astronomy.GeoVector(Astronomy.Body.Moon, time, true)
            );

            // Moon distance in km
            const moonGeo = Astronomy.GeoVector(Astronomy.Body.Moon, time, true);
            const moonDistAU = Math.sqrt(moonGeo.x * moonGeo.x + moonGeo.y * moonGeo.y + moonGeo.z * moonGeo.z);
            const moonDistKm = moonDistAU * 149597870.7;

            // Illumination
            const illum = Astronomy.Illumination(Astronomy.Body.Moon, time);

            return {
                sunAlt: sunHorizon.altitude,
                sunAz: sunHorizon.azimuth,
                moonAlt: moonHorizon.altitude,
                moonAz: moonHorizon.azimuth,
                elongation: elongation,
                moonDistKm: moonDistKm,
                illumination: illum.phase_fraction
            };
        }

        /**
         * Calculate crescent semi-width in arcminutes
         * Matches the Python implementation exactly
         */
        function calcCrescentWidth(arclDeg, moonAltDeg, distKm) {
            const EARTH_RADIUS = 6378.137;
            const sinPi = Math.min(EARTH_RADIUS / distKm, 1.0);
            const piRad = Math.asin(sinPi);
            const hRad = moonAltDeg * DEG2RAD;
            const sdRad = 0.27245 * piRad;
            const sdPrimeRad = sdRad * (1.0 + Math.sin(hRad) * Math.sin(piRad));
            const arclRad = arclDeg * DEG2RAD;
            const wPrimeRad = sdPrimeRad * (1.0 - Math.cos(arclRad));
            return wPrimeRad * RAD2DEG * 60.0;
        }

        /**
         * Yallop criterion - returns q value and classification
         */
        function yallopCriterion(arcl, arcv, wPrime) {
            const f = 11.8371 - 6.3226 * wPrime + 0.7319 * Math.pow(wPrime, 2) - 0.1018 * Math.pow(wPrime, 3);
            const q = (arcv - f) / 10.0;

            let cls, vis;
            if (q > 0.216) {
                cls = 'A'; vis = 'naked_eye_easy';
            } else if (q > -0.014) {
                cls = 'B'; vis = 'naked_eye_perfect';
            } else if (q > -0.160) {
                cls = 'C'; vis = 'mixed_optical_helpful';
            } else if (q > -0.232) {
                cls = 'D'; vis = 'optical_required';
            } else if (q > -0.293) {
                cls = 'E'; vis = 'not_visible_telescope';
            } else {
                cls = 'F'; vis = 'not_visible';
            }

            return { q, cls, vis };
        }

        /**
         * Odeh criterion - returns V value and zone
         */
        function odehCriterion(arcv, wArcmin) {
            const curve = -0.1018 * Math.pow(wArcmin, 3) + 0.7319 * Math.pow(wArcmin, 2) - 6.3226 * wArcmin + 7.1651;
            const v = arcv - curve;

            let zone, vis;
            if (v >= 5.65) {
                zone = 'A'; vis = 'naked_eye';
            } else if (v >= 2.0) {
                zone = 'B'; vis = 'naked_eye';
            } else if (v >= -0.96) {
                zone = 'C'; vis = 'optical_aid';
            } else {
                zone = 'D'; vis = 'not_visible';
            }

            return { v, zone, vis };
        }

        /**
         * Run the full calculation for a longitudinal line
         */
        function runCalculation() {
            if (typeof Astronomy === 'undefined') {
                log('Astronomy library not loaded!', 'error');
                return;
            }

            log('Starting visibility calculation...', 'info');
            const calcStart = performance.now();

            // Test parameters
            const TEST_DATE = { year: 2026, month: 2, day: 18 };
            const TEST_LON = 30.0;
            const LATITUDES = [];
            for (let lat = -60; lat <= 60; lat += 5) {
                LATITUDES.push(lat);
            }

            const results = [];

            for (const lat of LATITUDES) {
                try {
                    // Find sunset
                    const sunset = findSunset(lat, TEST_LON, TEST_DATE.year, TEST_DATE.month, TEST_DATE.day);

                    if (!sunset) {
                        results.push({ lat, error: 'no_sunset' });
                        continue;
                    }

                    // Get moon/sun data at sunset
                    const data = getMoonSunData(lat, TEST_LON, sunset);

                    // Calculate derived values
                    const arcl = data.elongation;
                    const arcv = data.moonAlt - data.sunAlt;
                    const wPrime = calcCrescentWidth(arcl, data.moonAlt, data.moonDistKm);

                    // Apply criteria
                    const yallop = yallopCriterion(arcl, arcv, wPrime);
                    const odeh = odehCriterion(arcv, wPrime);

                    results.push({
                        lat,
                        sunset: sunset.date.toISOString(),
                        sunAlt: data.sunAlt.toFixed(2),
                        moonAlt: data.moonAlt.toFixed(2),
                        elongation: arcl.toFixed(2),
                        wPrime: wPrime.toFixed(3),
                        yallopQ: yallop.q.toFixed(4),
                        yallopClass: yallop.cls,
                        odehV: odeh.v.toFixed(2),
                        zone: odeh.zone
                    });

                } catch (err) {
                    log(`Error at lat=${lat}: ${err.message}`, 'error');
                    results.push({ lat, error: err.message });
                }
            }

            const calcTime = ((performance.now() - calcStart)).toFixed(0);
            document.getElementById('calcTime').textContent = calcTime + 'ms';
            log(`Calculation completed in ${calcTime}ms`, 'success');
            log(`Processed ${results.length} points`, 'info');

            // Display results
            displayResults(results);

            return results;
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            for (const r of results) {
                const row = document.createElement('tr');

                if (r.error) {
                    row.innerHTML = `
                        <td>${r.lat}¬∞</td>
                        <td colspan="5" style="color: #E57373;">${r.error}</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${r.lat}¬∞</td>
                        <td>${r.sunset ? new Date(r.sunset).toISOString().slice(11, 19) : '-'}</td>
                        <td>${r.moonAlt}¬∞</td>
                        <td>${r.elongation}¬∞</td>
                        <td>${r.wPrime}'</td>
                        <td class="zone-${r.zone}">${r.zone}</td>
                    `;
                }
                tbody.appendChild(row);
            }

            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        // Initialize
        loadAstronomyLibrary();

        document.getElementById('runBtn').addEventListener('click', () => {
            runCalculation();
        });
    </script>
</body>

</html>